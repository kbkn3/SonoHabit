# 実装計画案: 楽器演奏練習補助アプリケーション

## 1. 前提条件

開発体制: 個人開発 (ご自身 + Cursor 等の AI 支援活用)
ターゲットプラットフォーム: macOS / iOS (Universal App)
UI フレームワーク: SwiftUI
データ永続化/同期:
SwiftData を採用 (ローカルデータ管理)
CloudKit を利用 (メタデータの iCloud 同期)
注意点: SwiftData は iOS 17 / macOS 14 以降が必要です。これより古い OS バージョンをサポートする必要がある場合は、Core Data を検討する必要があります。SwiftData+CloudKit の情報は Core Data に比べまだ少ない可能性があります。
デザイン: 標準コンポーネント主体で機能実装を優先。
開発期間: 特に定めず、学習と並行して段階的に進める。

## 2. 開発環境セットアップ

最新の Xcode をインストール。
Git でバージョン管理リポジトリを作成 (例: GitHub)。
Xcode で新規プロジェクトを作成:
Template: macOS / iOS -> App
Interface: SwiftUI
Storage: SwiftData
Include Tests にチェック推奨
必要に応じて Cursor 等の開発支援ツールを設定。

## 3. 実装フェーズ (段階的アプローチ)

### フェーズ 0: プロジェクト初期設定とプライバシー設定

目標: プロジェクトの基本設定とプライバシー関連の設定を完了させる。
タスク:

- プロジェクトの基本設定 (Bundle Identifier の設定、デプロイメントターゲットの確認)
- Info.plist の設定 (必要なプライバシー設定の追加)
  - マイク使用許可 (NSMicrophoneUsageDescription)
  - 音楽ライブラリアクセス許可 (NSAppleMusicUsageDescription)
- ファイル保存ディレクトリ構造の設計と実装:
  - アプリサンドボックス内の Documents ディレクトリに録音ファイル保存用フォルダを作成
  - 録音データと設定データの分離保存戦略の実装
- 多言語対応の基本設定 (Localizable.strings ファイルの作成)
  - 初期は日本語のみ対応
  - 将来の多言語対応を見据えた文字列の外部化

### フェーズ 1: データモデル定義と練習メニュー基本 UI (MVP コア - Part 1)

目標: 練習メニューと練習項目の基本的な情報を登録・表示・編集・削除できるようにする。
タスク:

- @Model を使用して SwiftData のデータモデルを定義する:
  - PracticeMenu: 名前、作成日、説明、アイコン（オプション）
    - 練習項目へのリレーションシップ (一対多)
  - PracticeItem: 名前、説明、順番、メトロノーム設定、評価履歴
    - 親メニューへのリレーションシップ (多対一)
  - UserSettings: アプリ全体の設定を保存
  - ModelContainer の設定 (CloudKit 連携を見据えた設定)
- SwiftUI で練習メニューの一覧表示画面を作成 (List)
- 練習メニューの追加・削除機能の実装 (@Environment(\.modelContext) を利用)
- 練習メニュー選択時に、そのメニューに含まれる練習項目の一覧表示画面へ遷移
- 練習項目の追加・編集・削除機能の実装
- 基本的な CRUD (作成/読み取り/更新/削除) 操作のテスト
- エラーハンドリング: データ保存失敗時の適切なユーザーフィードバック実装
- 単体テスト: モデル定義と CRUD 操作の基本テストケース実装
- ユーザビリティテスト: 基本操作の使いやすさ確認

### フェーズ 2: メトロノーム機能実装と連携 (MVP コア - Part 2)

目標: 独立したメトロノーム機能を実装し、練習項目と連携させる。MVP のコア機能完成。
タスク:

- AVFoundation (または必要なら Core Audio) を利用してメトロノームエンジンを実装するクラス/構造体を作成
  - 指定された BPM で正確なタイミングでイベントを発生させる
  - クリック音ファイルを再生する (AVAudioPlayer 等)
  - バックグラウンド実行のサポート
- SwiftUI でメトロノーム用のシンプルなコントロール UI を作成（再生/停止ボタン、BPM 表示・設定スライダー/テキストフィールド）
- SwiftData モデル (PracticeItem) にメトロノーム関連の属性を追加:
  - bpm: Int
  - timeSignatureNumerator: Int
  - timeSignatureDenominator: Int
  - totalBars: Int
  - repeatCount: Int
  - autoIncreaseBPM: Bool と関連設定
- 練習項目の詳細画面でメトロノーム設定を入力できるように UI を修正
- 練習メニュー画面または練習項目詳細画面から、「この設定でメトロノームを開始」するボタンを追加し、メトロノームエンジンと連携させる
- エラーハンドリング: オーディオセッション初期化失敗時の対応
- 単体テスト: メトロノームエンジンの正確性テスト
- ユーザビリティテスト: メトロノーム操作性の確認

### フェーズ 3: メトロノーム機能拡張

目標: メトロノーム機能を要件に合わせて拡張する。
タスク:

- BPM 自動段階上昇機能の実装:
  - 開始 BPM、目標 BPM、刻み幅、変化タイミング（小節数または繰り返し回数ベース）の設定 UI
  - メトロノームエンジンでの段階的 BPM 変更ロジック実装
- アクセント機能の実装:
  - 拍子内の任意の拍にアクセントを設定できる UI
  - アクセント拍で異なる音を再生する機能
- クリック音の選択機能の実装:
  - 複数の音声ファイルをリソースに追加
  - 音色選択 UI の実装と設定保存
- エラーハンドリング: 音声ファイル読み込み失敗時の代替処理
- 単体テスト: 拡張機能のテストケース追加
- ユーザビリティテスト: 機能が直感的に使えるか確認

### フェーズ 4: ファイル管理基盤と録音機能実装

目標: 録音データの保存基盤を確立し、基本的な録音機能を追加する。
タスク:

- ファイル管理サービスの実装:
  - アプリサンドボックス内のディレクトリ構造設計
  - 録音ファイル命名規則とメタデータ管理方法の確立
  - ファイルアクセスとセキュリティ処理の実装
- RecordingInfo モデルの実装:
  - 録音日時、関連練習項目、ファイルパス、自己評価などのメタデータ
  - CloudKit 同期設定 (@Model(cloudKit:) の詳細設定)
- AVFoundation (AVAudioEngine, AVAudioRecorder) を利用して録音機能を実装
- 入力ソースの選択機能:
  - 内蔵マイク/接続されている外部インターフェースをリストアップ (AVAudioSession)
  - 選択 UI の実装
- 可能な範囲での入力ゲイン調整機能
- 録音保存処理:
  - 初期は AAC(.m4a)形式で実装
  - ファイル名、メタデータ、関連 PracticeItem との紐付け
- 録音ファイルの再生機能 (AVAudioPlayer)
- 練習画面に録音開始/停止ボタンを追加し、録音データを該当の練習項目と紐付けて保存
- エラーハンドリング:
  - マイク許可が得られない場合の処理
  - ディスク容量不足時の処理
  - 録音保存失敗時の処理
- 単体テスト: 録音と再生機能のテスト
- ユーザビリティテスト: 録音操作の使いやすさ確認

### フェーズ 5: データ同期 (CloudKit)

目標: 練習メニューや設定、録音メタデータを iCloud で同期させる。
タスク:

- Apple Developer Program への登録確認
- Xcode プロジェクト設定で iCloud (CloudKit) を有効化し、コンテナを作成
- SwiftData のデータモデルに CloudKit 同期の詳細設定:
  - @Model(cloudKit:)パラメータの適切な設定
  - 各エンティティの同期対象属性の指定
  - 録音ファイルパスのみを同期対象とし、ファイル本体は同期対象外に
- CloudKit 同期マネージャーの実装:
  - 同期状態の監視
  - 競合解決戦略
  - エラー処理とリトライロジック
- 異なるデバイス間でのテスト:
  - Mac/iOS シミュレータ/実機間での同期確認
  - 同期競合時の挙動確認
- エラーハンドリング:
  - iCloud ログインなしの場合の適切な処理
  - 同期失敗時のユーザーフィードバック
  - オフライン動作の確保
- セキュリティ考慮事項:
  - 同期データの適切なアクセス制御
- 単体テスト: 同期機能のテスト
- ユーザビリティテスト: 同期操作と通知の確認

### フェーズ 6: 音源再生機能

目標: 外部音源ファイルをインポートし、再生コントロールを可能にする。
タスク:

- AudioSourceInfo モデルの実装:
  - 音源ファイル情報（名前、パス、ブックマークデータ等）
  - 関連練習項目とのリレーションシップ
- AVFoundation (AVPlayer) を利用した基本的な音源再生機能の実装
- ファイルインポート機能の実装:
  - Files App (Document Picker) を利用した選択 UI
  - セキュリティスコープブックマークの実装
  - ファイルアクセス権の管理
- A-B ループ機能の実装:
  - ループ範囲選択 UI
  - AVPlayer の再生範囲制御
- テンポ変更・ピッチ変更機能の実装:
  - AVAudioEngine と AVAudioUnitTimePitch の連携
  - コントロール UI の実装
- 音源再生と録音の同時実行機能:
  - AVAudioEngine での複数ソース処理
  - 音量バランス調整 UI の実装
- エラーハンドリング:
  - 不正なファイル形式への対応
  - ファイルアクセス失敗時の処理
- 単体テスト: 音源機能のテスト
- ユーザビリティテスト: 操作性と直感性の確認

### フェーズ 7: 自己評価機能と付加機能の実装

目標: 自己評価機能とその他付加機能を実装してアプリの機能を完成させる。
タスク:

- 自己評価機能の実装:
  - 3 段階評価 UI コンポーネントの作成
  - 評価データのモデル実装と保存処理
  - 練習項目との紐付け
- テンプレート機能の実装:
  - 事前定義されたメニュー/項目のデータ構造
  - テンプレートからの新規作成 UI
  - ユーザー作成テンプレート保存機能
- UI/UX の全体的な見直しと改善:
  - ナビゲーションフローの最適化
  - アクセシビリティ対応
  - ダークモード対応確認
- エラーハンドリングの総合的強化:
  - エラー表示の統一化
  - 復旧手順のガイダンス
- ドキュメント更新:
  - コード内ドキュメント (DocC 形式)
  - 技術的な決定事項の記録

### フェーズ 8: 品質向上と最終準備

目標: アプリ全体の品質を高め、リリースに向けた準備を整える。
タスク:

- 包括的なテスト:
  - 単体テストの網羅性向上
  - UI テストの追加
  - パフォーマンステスト (特にオーディオ処理と CloudKit 同期)
  - メモリリーク検出
- バグ修正と安定化:
  - エッジケースの処理改善
  - クラッシュレポート分析機能の追加
- 最適化:
  - 起動時間の改善
  - バッテリー消費の最適化
- リリース準備:
  - アプリアイコン作成
  - スクリーンショット準備
  - プライバシーポリシー作成
  - App Store 提出準備

## 4. 開発 Tips

小さく始める: 各フェーズの中でも、さらに小さなステップに分割して進める。
学習と実践: 初めての技術要素については、公式ドキュメント (Apple Developer) やチュートリアルで学習しながら進める。
AI 支援の活用: Cursor 等の AI ツールをコード生成、デバッグ、不明点の質問に積極的に活用する。
バージョン管理: Git でこまめにコミットし、ブランチを活用して機能開発を行う。
テスト: 各機能が実装できたら、必ず動作確認・テストを行う。
ドキュメント作成: 実装の各段階で技術的な決定事項や実装ノートを記録し、将来の拡張や修正を容易にする。
エラーハンドリング: 常にユーザー体験を考慮したエラー処理を実装する。

## 5. テスト戦略

### 5.1. 単体テスト

- モデルテスト: すべての SwiftData モデルの保存、取得、更新、削除操作
- サービステスト: 各サービスクラスの主要機能テスト
- ユーティリティテスト: ヘルパー関数とユーティリティのテスト

### 5.2. UI テスト

- 基本ナビゲーションフロー
- 各主要機能の操作テスト
- エッジケース (エラー状態等) の表示確認

### 5.3. パフォーマンステスト

- メトロノームの正確性テスト
- 大量データ時のリスト表示パフォーマンス
- 録音・再生時のリソース消費測定
- バッテリー消費測定

### 5.4. ユーザビリティテスト

- 各フェーズ終了時に基本的な操作性確認
- フェーズ 1〜3 完了後の初期 MVP でのベータテスト計画
- 完成版でのユーザーフィードバック収集計画

## 6. ドキュメント計画

### 6.1. コード内ドキュメント

- すべての公開 API、クラス、構造体に DocC 形式のドキュメント
- 複雑なロジックには詳細なコメント
- MARK: コメントによるコード構造の明確化

### 6.2. 開発者ドキュメント

- アーキテクチャ概要図
- データフロー図
- 技術的決定事項の記録
- 既知の制限事項

### 6.3. ユーザードキュメント

- 機能概要
- 使い方ガイド
- よくある質問 (FAQ)
